<!-- พื้นหลังอ่อน -->
<div class="py-5" style="background-color: #eaf6f9;">

  <div class="container" style="max-width: 1400px;">
    @if (!token || token.trim().length === 0) {
    <!-- กล่อง Dashboard หลัก -->
    <div class="card shadow border-0 mb-5" style="border-radius: 12px;">
      <div class="card-header text-white" style="background:#36393c; border-top-left-radius:12px; border-top-right-radius:12px;">
        <h4 class="mb-0">
          <i class="fas fa-chart-line me-2"></i> Dashboard
        </h4>
      </div>
      <div class="card-body p-4">
        
        <app-chart
          [lamRows]="buildLamination.Rows"
          [genRows]="buildGeneral.Rows"
          [staRows]="buildStator.Rows"
          [callNodeRows]="callNodes"
          >
        </app-chart> 
       
        <!-- ✅ Divider ระหว่าง Chart กับ List -->
        <div class="dash-divider my-4"></div>
        
        <!-- Dashboard 1 -->
        <div class="card border-0 mb-4" style="border-radius:10px; background-color:#e0e0e0;">
         
          <div class="card-header text-white fw-semibold" 
               style="background-color:#2c2c2c; border-top-left-radius:10px; border-top-right-radius:10px;">
            Job transaction for lamination
          </div>

          <div class="card-body">
            <!-- แถวสรุป Lamination -->
            <div class="d-flex justify-content-between align-items-center p-3 rounded" 
                 style="background:#79f2a2;">
              <span class="fw-semibold">Lamination</span>
        
            
              <div class="d-flex gap-4">
                <span 
                  class="summary-chip"
                  [ngClass]="{ 'notify': checkUnAuthorizedLamNotifyWait === 1 }"
                  >
                    <ng-container *ngIf="checkUnAuthorizedLamNotifyWait === 1">
                      <i class="fas fa-bell blink me-1"></i>
                    </ng-container>
                    wait : {{ buildLamination.waitCount }}  
                </span>
                <span 
                class="summary-chip"
                [ngClass]="{ 'pending-notify': checkUnAuthorizedLamNotifyPending === 1 }"
              >
              <ng-container *ngIf="checkUnAuthorizedLamNotifyPending === 1">
                <i class="fas fa-bell blink me-1"></i>
              </ng-container>
              pending : {{ buildLamination.pendingCount }}
              </span
                >
              <button
                class="btn btn-sm btn-outline-dark"
                (click)="toggleLamPreview()">
                {{ showLamPreview ? 'Hide detail' : 'View detail' }}
             </button> 
              </div>
            </div>
        
           
            <div *ngIf="showLamPreview" class="mt-3">
              <!-- กล่องที่ *จำกัดความสูง* และมี scrollbar -->
              <div class="lam-preview-scroll"
              #lamScroll
              (scroll)="onLamScroll()"
              (click)="onLamClick()"
              >
              <div class="list-group rounded-3 overflow-hidden">
                <ng-container *ngIf="buildLamination.Rows.length > 0; else noJobTpl">
                  <div
                    class="list-group-item d-flex align-items-center justify-content-between"
                    [ngClass]="{ 'row-late': isJobLate(item) }"
                    *ngFor="let item of buildLamination.Rows"
                  >
                    <div class="d-flex align-items-center gap-3">
                      <span class="mono fw-semibold">{{ item.date }}</span>
                      <span class="mono fw-semibold">{{ item.time }}</span>
                      <span class="fw-semibold">{{ item.machineName }}</span>
                      @if (item.priority === "urgent") {
                        <span class="urgent-badge">
                          <i class="fas fa-fire"></i>
                        </span>
                      }
                    </div>

                      <div class="d-flex align-items-center gap-2"> 
                        <span class="node-tag" >{{ item.toNodeName }}</span>
                        <span
                        class="badge rounded-pill px-3 py-2 text-capitalize status-pill"
                        [ngClass]="item.status === 'wait' ? 'status-wait' : 'status-pending'"
                      >
                        {{ item.status }}
                      </span>
                      <button
                      class="detail-icon-btn"
                      (click)="onDetail(item)"
                      title="View detail"
                    >
                      <i class="fas fa-bars"></i>
                   </button>
                    </div>
                    
                  </div>
                </ng-container>
                <ng-template #noJobTpl>
                  <div class="empty-box">
                    <img src="dist/img/no-task.png" alt="no job" />
                    <div class="empty-text">No job request</div>
                  </div>
                </ng-template>
                </div>
              </div>
            </div>
          </div>


        </div>

        <!-- Dashboard 2 -->
        <div class="card border-0 mb-4" style="border-radius:10px; background-color:#e0e0e0;">
          <div class="card-header text-white fw-semibold" 
               style="background-color:#2c2c2c; border-top-left-radius:10px; border-top-right-radius:10px;">
            Job transaction for General & Stator
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <div class="d-flex justify-content-between align-items-center p-3 rounded" 
                     style="background:#d4f787;">
                  <span class="fw-semibold">General</span>

                  <div class="d-flex gap-2">
                      <span 
                        class="summary-chip"
                        [ngClass]="{ 'notify': checkUnAuthorizedGenNotifyWait=== 1 }"
                        >
                          <ng-container *ngIf=" checkUnAuthorizedGenNotifyWait === 1">
                            <i class="fas fa-bell blink me-1"></i>
                          </ng-container>
                          wait : {{ buildGeneral.waitCount }}  
                      </span>
                      <span 
                      class="summary-chip"
                      [ngClass]="{ 'pending-notify': checkUnAuthorizedGenNotifyPending === 1 }"
                    >
                    <ng-container *ngIf="checkUnAuthorizedGenNotifyPending === 1">
                      <i class="fas fa-bell blink me-1"></i>
                    </ng-container>
                    pending : {{ buildGeneral.pendingCount }}
                    </span
                      >
                      <button
                      class="btn btn-sm btn-outline-dark"
                      (click)="toggleGenPreview()">
                      {{ showGenPreview ? 'Hide detail' : 'View detail' }}
                    </button>
                  </div>
                </div>

                 <!-- preview General -->
                  <div *ngIf="showGenPreview" class="mt-2">
                    <div class="lam-preview-scroll"
                    #genScroll
                    (scroll)="onGenScroll()"
                    (click)="onGenClick()"
                    >
                    <div class="list-group rounded-3 overflow-hidden">
                      <ng-container *ngIf="buildGeneral.Rows.length > 0; else noJobTpl">
                        <div
                          class="list-group-item d-flex align-items-center justify-content-between"
                          [ngClass]="{ 'row-late': isJobLate(item) }"
                          *ngFor="let item of buildGeneral.Rows"
                        >
                          <div class="d-flex align-items-center gap-3">
                            <span class="mono fw-semibold">{{ item.date }}</span>
                            <span class="mono fw-semibold">{{ item.time }}</span>
                            <span class="fw-semibold">{{ item.machineName }}</span>
                            @if (item.priority === "urgent") {
                              <span class="urgent-badge">
                                <i class="fas fa-fire"></i>
                              </span>
                            }
                          </div>
                          <div class="d-flex align-items-center gap-2"> 
                          <span class="node-tag" >{{ item.toNodeName }}</span>
                          <span
                          class="badge rounded-pill px-3 py-2 text-capitalize status-pill"
                          [ngClass]="item.status === 'wait' ? 'status-wait' : 'status-pending'"
                        >
                          {{ item.status }}
                        </span>

                        <button
                        class="detail-icon-btn"
                        (click)="onDetail(item)"
                        title="View detail"
                      >
                        <i class="fas fa-bars"></i>
                     </button>
                        </div>

                        </div>
                       </ng-container>
                        <ng-template #noJobTpl>
                          <div class="empty-box">
                            <img src="dist/img/no-task.png" alt="no job" />
                            <div class="empty-text">No job request</div>
                          </div>
                        </ng-template>
                      </div>
                     
                    </div>
                  </div>

              </div>

              <div class="col-md-6">
                <div class="d-flex justify-content-between align-items-center p-3 rounded" 
                     style="background:#9feefc;">
                  <span class="fw-semibold">Stator</span>
                  
                  <div class="d-flex gap-2">
                    <span 
                      class="summary-chip"
                      [ngClass]="{ 'notify': checkUnAuthorizedStaNotifyWait === 1 }"
                      >
                        <ng-container *ngIf="checkUnAuthorizedStaNotifyWait === 1">
                          <i class="fas fa-bell blink me-1"></i>
                        </ng-container>
                        wait : {{ buildStator.waitCount }}  
                    </span>
                    <span 
                    class="summary-chip"
                    [ngClass]="{ 'pending-notify': checkUnAuthorizedStaNotifyPending === 1 }"
                  >
                  <ng-container *ngIf="checkUnAuthorizedStaNotifyPending === 1">
                    <i class="fas fa-bell blink me-1"></i>
                  </ng-container>
                  pending : {{ buildStator.pendingCount }}
                  </span
                    >
                    <button
                    class="btn btn-sm btn-outline-dark"
                    (click)="toggleStaPreview()">
                    {{ showStaPreview ? 'Hide detail' : 'View detail' }}
                  </button>
                </div>


                </div>

                   <!-- preview Stator -->
                <div *ngIf="showStaPreview" class="mt-2">
                  <div class="lam-preview-scroll"
                  #staScroll
                  (scroll)="onStaScroll()"
                  (click)="onStaClick()"
                  >
                  <div class="list-group rounded-3 overflow-hidden">
                    <ng-container *ngIf="buildStator.Rows.length > 0; else noJobTpl">
                      <div
                        class="list-group-item d-flex align-items-center justify-content-between"
                        [ngClass]="{ 'row-late': isJobLate(item) }"
                        *ngFor="let item of buildStator.Rows"
                      >
                        <div class="d-flex align-items-center gap-3">
                          <span class="mono fw-semibold">{{ item.date }}</span>
                          <span class="mono fw-semibold">{{ item.time }}</span>
                          <span class="fw-semibold">{{ item.machineName }}</span>
                          @if (item.priority === "urgent") {
                            <span class="urgent-badge">
                              <i class="fas fa-fire"></i>
                            </span>
                          }
                        </div>
                        <div class="d-flex align-items-center gap-2"> 
                        <span class="node-tag" >{{ item.toNodeName }}</span>
                        <span
                        class="badge rounded-pill px-3 py-2 text-capitalize status-pill"
                        [ngClass]="item.status === 'wait' ? 'status-wait' : 'status-pending'"
                      >
                        {{ item.status }}
                      </span>

                      <button
                        class="detail-icon-btn"
                        (click)="onDetail(item)"
                        title="View detail"
                      >
                        <i class="fas fa-bars"></i>
                     </button>
                      </div>
                      
                      </div>
                    </ng-container>
                    <ng-template #noJobTpl>
                      <div class="empty-box">
                        <img src="dist/img/no-task.png" alt="no job" />
                        <div class="empty-text">No job request</div>
                      </div>
                    </ng-template>
                    </div>
                  </div>
                  </div>

              </div>

            </div>
          </div>
        </div>

      </div> <!-- card-body -->
    </div> <!-- card -->
  }
  @if(groupDashboard === "Lamination"){
      <!-- Lamination -->
    <app-lamination-panel  
    [laminationData]="buildLamination" 
    [checkNotifyWait]="checkLamNotifyWait" 
    (notifyWaitCleared)="checkLamNotifyWait = 0" 
    (notifyPendingCleared)="checkLamNotifyPending = 0"
    [checkNotifyPending]="checkLamNotifyPending" >
  </app-lamination-panel>
                
  }
  @if( groupDashboard === "General" || groupDashboard === "Stator"){ 
      <!-- General & Stator -->
    <app-general-stator-panel 
    [general]="buildGeneral" 
    [stator]="buildStator"
    [checkGenNotifyWait]="checkGenNotifyWait" 
    [checkGenNotifyPending]="checkGenNotifyPending"
    [checkStaNotifyWait]="checkStaNotifyWait"
    [checkStaNotifyPending]="checkStaNotifyPending"
    (notifyGenWaitCleared)="checkGenNotifyWait = 0"
    (notifyGenPendingCleared)="checkGenNotifyPending = 0"
    (notifyStaWaitCleared)="checkStaNotifyWait = 0"
    (notifyStaPendingCleared)="checkStaNotifyPending = 0"
    >
  </app-general-stator-panel>
  }

  </div> <!-- container -->
</div>

<app-modal-template
#assignJobModal
></app-modal-template>


<app-alert-request
#alertRequestModal
>
</app-alert-request>
